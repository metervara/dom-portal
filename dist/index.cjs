"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const A=["top-left-outer","top-left-inner","top-right-outer","top-right-inner","bottom-left-outer","bottom-left-inner","bottom-right-outer","bottom-right-inner"];class v{constructor(t){this.portalElement=null,this.portalCenterX=0,this.portalCenterY=0,this.portalWidthOpenHalf=0,this.state="closed",this.animationFrameId=null,this.transitionGeneration=0,this.transitionEndHandler=null,this.transitionElement=null,this.targetElement=t,this.parentElement=t.parentElement;const e=window.getComputedStyle(this.parentElement);e.position==="relative"||e.position==="absolute"||console.error("Dom portal only works if the parent of the target element is positioned relative or absolute"),this.resizeObserver=new ResizeObserver(()=>{this.state!=="closed"&&(this.measureRects(),this.portalElement?.style.setProperty("--clone-width",`${Math.round(this.targetRect.width)}px`),this.portalElement?.style.setProperty("--clone-height",`${Math.round(this.targetRect.height)}px`))}),this.resizeObserver.observe(this.targetElement),this.handleGlobalClick=a=>{this.state==="closed"||(console.log("handleGlobalClick",a),a.target.closest(".metervara-portal-content-container"))||(console.log("closePortal from handleGlobalClick"),this.closePortal(0,0))},document.addEventListener("click",this.handleGlobalClick,!0)}async openAndReady(t,e,i){return this.openPortal(t,e,i),new Promise((a,l)=>{const r=()=>{const o=document.querySelector(".metervara-portal-content-container");o?a(o):this.state==="closed"?l(new Error("Portal closed before container was ready")):requestAnimationFrame(r)};requestAnimationFrame(r)})}openPortal(t,e,i){this.state==="closed"&&(this.measureRects(),this.portalWidthOpenHalf=this.parseSize(i)*.5,this.portalCenterX=t-this.parentRect.left,this.portalCenterY=e-this.parentRect.top,this.createPortalElements(),requestAnimationFrame(()=>{this.open()}))}closePortal(t,e,i={}){if(!(this.state!=="open"&&this.state!=="opening")){if(console.log("closePortal",this.state),i.instant){console.log("closePortal instant"),this.clearTransitionListener(),this.setState("closed"),this.deletePortalElements();return}this.state==="opening"&&(this.clearTransitionListener(),this.setState("open")),this.close()}}togglePortal(t,e){this.state==="closed"?this.openPortal(t,e):(this.state==="open"||this.state==="opening")&&this.closePortal(t,e)}destroy(){this.resizeObserver.disconnect(),document.removeEventListener("click",this.handleGlobalClick,!0),this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.clearTransitionListener(),this.deletePortalElements()}parseSize(t){const e=this.parentRect.width*.25;if(!t)return e;if(t.endsWith("px"))return parseFloat(t);if(t.endsWith("vw")){const i=parseFloat(t);return window.innerWidth*i/100}else if(t.endsWith("vh")){const i=parseFloat(t);return window.innerHeight*i/100}return e}measureRects(){this.parentRect=this.parentElement.getBoundingClientRect(),this.targetRect=this.targetElement.getBoundingClientRect()}createPortalElements(t=1){this.portalElement=document.createElement("div"),this.portalElement.classList.add("metervara-portal"),this.parentElement?.appendChild(this.portalElement),this.portalElement.style.setProperty("--portal-center-x",`${Math.round(this.portalCenterX)}px`),this.portalElement.style.setProperty("--portal-center-y",`${Math.round(this.portalCenterY)}px`),this.portalElement.style.setProperty("--clone-width",`${Math.round(this.targetRect.width)}px`),this.portalElement.style.setProperty("--clone-height",`${Math.round(this.targetRect.height)}px`);const e=50;this.portalElement.style.setProperty("--hole-layer-width",`${e}px`),this.portalElement.style.setProperty("--portal-width-open-half",`${Math.round(this.portalWidthOpenHalf)}px`),this.portalElement.style.setProperty("--portal-width-inner-half",`${Math.round(this.portalWidthOpenHalf-e*(t-1))}px`),A.forEach(r=>{const o=document.createElement("div");o.classList.add("metervara-portal-zone"),o.classList.add(...r.split("-").map(s=>`zone-${s}`));const c=this.targetElement.cloneNode(!0);c.classList.add("metervara-portal-clone"),o.appendChild(c),this.portalElement.appendChild(o)});const i=document.createElement("div");i.classList.add("metervara-portal-border","top"),this.portalElement.appendChild(i);const a=document.createElement("div");a.classList.add("metervara-portal-border","bottom"),this.portalElement.appendChild(a);const l=document.createElement("div");l.classList.add("metervara-portal-content-container"),this.portalElement.appendChild(l)}deletePortalElements(){this.portalElement&&(this.portalElement.innerHTML="",this.portalElement.remove(),this.portalElement=null)}setState(t){this.state=t;const e=t!=="closed";this.targetElement.style.visibility=e?"hidden":"visible";const i=new CustomEvent("portal:"+t,{detail:{portalElement:this.portalElement,targetElement:this.targetElement}});window.dispatchEvent(i)}open(t=750,e=100){this.state==="closed"&&(this.setState("opening"),this.animateTransition(0,1,t,e,this.onOpened.bind(this)))}close(t=750,e=100){this.state==="open"&&(this.setState("closing"),this.animateTransition(1,0,t,e,this.onClosed.bind(this)))}onOpened(){console.log("ON OPENED"),this.setState("open")}onClosed(){console.log("ON CLOSED"),this.setState("closed"),this.deletePortalElements()}animateTransition(t,e,i,a,l){console.log("animateTransition",t,e,i,a),this.clearTransitionListener();const r=++this.transitionGeneration;e===1?this.portalElement?.classList.add("open"):e===0&&this.portalElement?.classList.remove("open");const o=this.portalElement?.querySelector(".metervara-portal-zone.zone-left.zone-outer");if(!o){console.log("animateTransition no referenceElement.. aborting"),l();return}this.transitionElement=o,this.transitionEndHandler=c=>{c.target!==o||c.propertyName!=="transform"||(console.log("animateTransition transitionend"),this.clearTransitionListener(),r===this.transitionGeneration&&(console.log("animateTransition onComplete"),l()))},o.addEventListener("transitionend",this.transitionEndHandler)}clearTransitionListener(){this.transitionEndHandler&&this.transitionElement&&this.transitionElement.removeEventListener("transitionend",this.transitionEndHandler),this.transitionEndHandler=null,this.transitionElement=null}}class P{constructor(t={}){this.mode=t.mode||"query",this.key=t.portalKey||"portal"}init(t){this.callback=t,window.addEventListener("popstate",()=>this.handleRouteChange()),window.addEventListener("hashchange",()=>this.handleRouteChange()),this.handleRouteChange()}handleRouteChange(){const t=this.getCurrentRoute();this.callback?.(t)}getCurrentRoute(){if(this.mode==="hash"){const[t,e]=window.location.hash.slice(1).split("/");return{page:t||"",portal:e}}else{const t=new URL(window.location.href);return{page:t.pathname.replace(/^\/+/,""),portal:t.searchParams.get(this.key)||void 0}}}open(t){if(this.mode==="hash"){const{page:e}=this.getCurrentRoute();window.location.hash=`${e}/${t}`}else{const e=new URL(window.location.href);e.searchParams.set(this.key,t),history.pushState({},"",e.toString())}this.handleRouteChange()}close(){if(this.mode==="hash"){const{page:t}=this.getCurrentRoute();window.location.hash=`${t}/`}else{const t=new URL(window.location.href);t.searchParams.delete(this.key),history.pushState({},"",t.toString())}this.handleRouteChange()}}function y(n){n.querySelectorAll("script").forEach(t=>{const e=document.createElement("script");e.type=t.type||"text/javascript",console.log(t),t.src?e.src=t.src:e.textContent=t.textContent,t.parentNode?.replaceChild(e,t)})}function E(n){return n.dataset.portalRegion==="main"?n:n.querySelector('[data-portal-region="main"]')}function S(n){n.id&&n.removeAttribute("id"),n.querySelectorAll("[id]").forEach(t=>{t.removeAttribute("id")})}const w=new Map;function C(){for(const[n,t]of w){const{placeholder:e,parent:i,wasHidden:a,previousDisplay:l}=t;e.parentNode?e.parentNode.replaceChild(n,e):i.appendChild(n),a?n.setAttribute("hidden",""):n.removeAttribute("hidden"),l!==null?n.style.display=l:n.style.removeProperty("display"),w.delete(n)}}async function b(n,t,e){if(C(),n.innerHTML="",e.type==="inline"){const r=document.querySelector(e.selector);if(!r)throw new Error(`Inline portal source "${e.selector}" not found`);const o=E(r);if(!o)throw new Error(`No content region found in inline source "${e.selector}"`);if((e.mode||"clone")==="move"){const h=o.parentNode;if(!h)throw new Error(`Inline portal source "${e.selector}" has no parent`);const p=document.createComment("portal-inline-placeholder");h.insertBefore(p,o);const u=o.style.display||null,m=o.hasAttribute("hidden");o.removeAttribute("hidden"),o.style.removeProperty("display"),w.set(o,{placeholder:p,parent:h,wasHidden:m,previousDisplay:u}),n.appendChild(o);return}const s=r.cloneNode(!0);s.removeAttribute("hidden"),s.style.removeProperty("display"),S(s);const d=E(s);if(!d)throw new Error(`No content region found in inline source "${e.selector}"`);n.appendChild(d),y(d);return}if(e.type==="external"){const r=document.createElement("iframe");r.onload=()=>{r.classList.add("loaded")},r.src=e.url,r.allow="fullscreen; pointer-lock",n.appendChild(r);return}const i=await fetch(e.path).then(r=>r.text()),a=document.createElement("div");a.innerHTML=i;const l=E(a);if(!l)throw new Error(`No content region found in ${e.path}`);n.appendChild(l),y(l)}function R(){C(),document.querySelectorAll(".metervara-portal .metervara-portal-content-container [data-portal-region='main']").forEach(t=>t.remove())}function L(){document.addEventListener("click",n=>{const e=n.target.closest("[data-portal]");if(e){n.preventDefault();const i=e.getAttribute("data-portal");if(!i)return;const a=e.getAttribute("data-portal-path"),l=e.getAttribute("data-portal-url"),r=e.getAttribute("data-portal-inline"),o=e.getAttribute("data-portal-inline-mode"),c=n.clientX,s=n.clientY,d=e.getAttribute("data-portal-size")||void 0;window.dispatchEvent(new CustomEvent("portal:trigger",{detail:{portalName:i,clickX:c,clickY:s,path:a,externalUrl:l,inlineSelector:r,inlineMode:o,size:d}}))}})}function $(n){const t=document.querySelector(n.portalTarget);if(!t)throw new Error(`Portal target "${n.portalTarget}" not found`);const e=new v(t),i=n.routerMode||"query",a=i==="none"?void 0:new P({mode:i});let l=!1;return L(),window.addEventListener("portal:trigger",async r=>{const{portalName:o,clickX:c,clickY:s,path:d,externalUrl:h,inlineSelector:p,inlineMode:u,size:m,scrollIntoView:k=!1}=r.detail;try{const g=await e.openAndReady(c,s,m);let f;if(p?f={type:"inline",selector:p,mode:u}:h?f={type:"external",url:h}:f={type:"html",path:d||`/portal/content/${o}.html`},await b(g,o,f),a){l=!0;try{a.open(o)}finally{l=!1}}k&&window.scrollTo({top:s-window.innerHeight/2,behavior:"smooth"})}catch(g){console.error("Portal failed to open:",g)}}),window.addEventListener("portal:closed",()=>{if(R(),a){l=!0;try{a.close()}finally{l=!1}}}),a?.init(async({portal:r})=>{if(l)return;if(!r){e.closePortal(0,0);return}const o=document.querySelector(`[data-portal="${r}"]`);if(!o){console.warn(`No portal link found for '${r}'`);return}const c=o?.getAttribute("data-portal-path"),s=o?.getAttribute("data-portal-url"),d=o?.getAttribute("data-portal-inline"),h=o?.getBoundingClientRect(),p=h.left+h.width/2,u=h.top+h.height/2+window.scrollY,m=new CustomEvent("portal:trigger",{detail:{portalName:r,clickX:p,clickY:u,path:c||(d?void 0:`/portal/content/${r}.html`),externalUrl:s,inlineSelector:d,scrollIntoView:!0}});window.dispatchEvent(m)}),{portal:e,router:a}}function x(n){return`Hello, ${n}!`}exports.DomPortal=v;exports.PortalRouter=P;exports.enhancePortalLinks=L;exports.hello=x;exports.loadPortalContent=b;exports.setupDomPortal=$;exports.unloadPortalContent=R;
//# sourceMappingURL=index.cjs.map
