"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const b=["top-left-outer","top-left-inner","top-right-outer","top-right-inner","bottom-left-outer","bottom-left-inner","bottom-right-outer","bottom-right-inner"];class y{constructor(t){this.portalElement=null,this.portalCenterX=0,this.portalCenterY=0,this.portalWidthOpenHalf=0,this.state="closed",this.animationFrameId=null,this.transitionTimeoutId=null,this.targetElement=t,this.parentElement=t.parentElement;const e=window.getComputedStyle(this.parentElement);e.position==="relative"||e.position==="absolute"||console.error("Dom portal only works if the parent of the target element is positioned relative or absolute"),this.resizeObserver=new ResizeObserver(()=>{this.state!=="closed"&&(this.measureRects(),this.portalElement?.style.setProperty("--clone-width",`${this.targetRect.width}px`),this.portalElement?.style.setProperty("--clone-height",`${this.targetRect.height}px`))}),this.resizeObserver.observe(this.targetElement),this.handleGlobalPointerDown=a=>{this.state==="closed"||a.target.closest(".metervara-portal-content-container")||this.closePortal(0,0)},document.addEventListener("pointerdown",this.handleGlobalPointerDown,!0),this.handleWindowResize=()=>{this.state!=="closed"&&this.closePortal(0,0,{instant:!0})},window.addEventListener("resize",this.handleWindowResize)}async openAndReady(t,e,o){return this.openPortal(t,e,o),new Promise((a,s)=>{const n=()=>{const i=document.querySelector(".metervara-portal-content-container");i?a(i):this.state==="closed"?s(new Error("Portal closed before container was ready")):requestAnimationFrame(n)};requestAnimationFrame(n)})}openPortal(t,e,o){this.state==="closed"&&(this.measureRects(),this.portalWidthOpenHalf=this.parseSize(o)*.5,this.portalCenterX=t-this.parentRect.left,this.portalCenterY=e-this.parentRect.top,this.createPortalElements(),requestAnimationFrame(()=>{this.open()}))}closePortal(t,e,o={}){if(!(this.state!=="open"&&this.state!=="opening")){if(o.instant){this.clearTransitionTimeout(),this.setState("closed"),this.deletePortalElements();return}this.state==="opening"&&(this.clearTransitionTimeout(),this.setState("open")),this.close()}}togglePortal(t,e){this.state==="closed"?this.openPortal(t,e):(this.state==="open"||this.state==="opening")&&this.closePortal(t,e)}destroy(){this.resizeObserver.disconnect(),document.removeEventListener("pointerdown",this.handleGlobalPointerDown,!0),window.removeEventListener("resize",this.handleWindowResize),this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.clearTransitionTimeout(),this.deletePortalElements()}parseSize(t){const e=this.parentRect.width*.25;if(!t)return e;if(t.endsWith("px"))return parseFloat(t);if(t.endsWith("vw")){const o=parseFloat(t);return window.innerWidth*o/100}else if(t.endsWith("vh")){const o=parseFloat(t);return window.innerHeight*o/100}return e}measureRects(){this.parentRect=this.parentElement.getBoundingClientRect(),this.targetRect=this.targetElement.getBoundingClientRect()}createPortalElements(t=1){this.portalElement=document.createElement("div"),this.portalElement.classList.add("metervara-portal"),this.parentElement?.appendChild(this.portalElement),this.portalElement.style.setProperty("--portal-center-x",`${Math.round(this.portalCenterX)}px`),this.portalElement.style.setProperty("--portal-center-y",`${Math.round(this.portalCenterY)}px`),this.portalElement.style.setProperty("--clone-width",`${this.targetRect.width}px`),this.portalElement.style.setProperty("--clone-height",`${this.targetRect.height}px`);const e=50;this.portalElement.style.setProperty("--hole-layer-width",`${e}px`),this.portalElement.style.setProperty("--portal-width-open-half",`${this.portalWidthOpenHalf}px`),this.portalElement.style.setProperty("--portal-width-inner-half",`${this.portalWidthOpenHalf-e*(t-1)}px`),b.forEach(n=>{const i=document.createElement("div");i.classList.add("metervara-portal-zone"),i.classList.add(...n.split("-").map(h=>`zone-${h}`));const l=this.targetElement.cloneNode(!0);l.classList.add("metervara-portal-clone"),i.appendChild(l),this.portalElement.appendChild(i)});const o=document.createElement("div");o.classList.add("metervara-portal-border","top"),this.portalElement.appendChild(o);const a=document.createElement("div");a.classList.add("metervara-portal-border","bottom"),this.portalElement.appendChild(a);const s=document.createElement("div");s.classList.add("metervara-portal-content-container"),this.portalElement.appendChild(s),this.portalElement.addEventListener("pointerdown",n=>{n.target.closest(".metervara-portal-content-container")||this.closePortal(0,0)})}deletePortalElements(){this.portalElement&&(this.portalElement.innerHTML="",this.portalElement.remove(),this.portalElement=null)}setState(t){this.state=t;const e=t!=="closed";this.targetElement.style.visibility=e?"hidden":"visible";const o=new CustomEvent("portal:"+t,{detail:{portalElement:this.portalElement,targetElement:this.targetElement}});window.dispatchEvent(o)}open(t=750,e=100){this.state==="closed"&&(this.setState("opening"),this.animateTransition(0,1,t,e,this.onOpened.bind(this)))}close(t=750,e=100){this.state==="open"&&(this.setState("closing"),this.animateTransition(1,0,t,e,this.onClosed.bind(this)))}onOpened(){this.setState("open")}onClosed(){this.setState("closed"),this.deletePortalElements()}animateTransition(t,e,o,a,s){e===1?this.portalElement?.classList.add("open"):e===0&&this.portalElement?.classList.remove("open"),this.clearTransitionTimeout(),this.transitionTimeoutId=window.setTimeout(()=>{this.transitionTimeoutId=null,s()},o)}clearTransitionTimeout(){this.transitionTimeoutId!==null&&(clearTimeout(this.transitionTimeoutId),this.transitionTimeoutId=null)}}class v{constructor(t={}){this.mode=t.mode||"query",this.key=t.portalKey||"portal"}init(t){this.callback=t,window.addEventListener("popstate",()=>this.handleRouteChange()),window.addEventListener("hashchange",()=>this.handleRouteChange()),this.handleRouteChange()}handleRouteChange(){const t=this.getCurrentRoute();this.callback?.(t)}getCurrentRoute(){if(this.mode==="hash"){const[t,e]=window.location.hash.slice(1).split("/");return{page:t||"",portal:e}}else{const t=new URL(window.location.href);return{page:t.pathname.replace(/^\/+/,""),portal:t.searchParams.get(this.key)||void 0}}}open(t){if(this.mode==="hash"){const{page:e}=this.getCurrentRoute();window.location.hash=`${e}/${t}`}else{const e=new URL(window.location.href);e.searchParams.set(this.key,t),history.pushState({},"",e.toString())}this.handleRouteChange()}close(){if(this.mode==="hash"){const{page:t}=this.getCurrentRoute();window.location.hash=`${t}/`}else{const t=new URL(window.location.href);t.searchParams.delete(this.key),history.pushState({},"",t.toString())}this.handleRouteChange()}}function w(r){r.querySelectorAll("script").forEach(t=>{const e=document.createElement("script");e.type=t.type||"text/javascript",console.log(t),t.src?e.src=t.src:e.textContent=t.textContent,t.parentNode?.replaceChild(e,t)})}function E(r){return r.dataset.portalRegion==="main"?r:r.querySelector('[data-portal-region="main"]')}async function P(r,t,e){if(r.innerHTML="",e.type==="inline"){const n=document.querySelector(e.selector);if(!n)throw new Error(`Inline portal source "${e.selector}" not found`);const i=n.cloneNode(!0);i.removeAttribute("hidden"),i.style.removeProperty("display");const l=E(i);if(!l)throw new Error(`No content region found in inline source "${e.selector}"`);r.appendChild(l),w(l);return}if(e.type==="external"){const n=document.createElement("iframe");n.onload=()=>{n.classList.add("loaded")},n.src=e.url,n.allow="fullscreen; pointer-lock",r.appendChild(n);return}const o=await fetch(e.path).then(n=>n.text()),a=document.createElement("div");a.innerHTML=o;const s=E(a);if(!s)throw new Error(`No content region found in ${e.path}`);r.appendChild(s),w(s)}function R(){document.querySelectorAll(".metervara-portal .metervara-portal-content-container [data-portal-region='main']").forEach(t=>t.remove())}function C(){document.addEventListener("click",r=>{const e=r.target.closest("[data-portal]");if(e){r.preventDefault();const o=e.getAttribute("data-portal");if(!o)return;const a=e.getAttribute("data-portal-path"),s=e.getAttribute("data-portal-url"),n=e.getAttribute("data-portal-inline"),i=r.clientX,l=r.clientY,h=e.getAttribute("data-portal-size")||void 0;window.dispatchEvent(new CustomEvent("portal:trigger",{detail:{portalName:o,clickX:i,clickY:l,path:a,externalUrl:s,inlineSelector:n,size:h}}))}})}function T(r){const t=document.querySelector(r.portalTarget);if(!t)throw new Error(`Portal target "${r.portalTarget}" not found`);const e=new y(t),o=r.routerMode||"query",a=o==="none"?void 0:new v({mode:o});let s=!1;return C(),window.addEventListener("portal:trigger",async n=>{const{portalName:i,clickX:l,clickY:h,path:d,externalUrl:c,inlineSelector:p,size:m,scrollIntoView:g=!1}=n.detail;try{const f=await e.openAndReady(l,h,m);let u;if(p?u={type:"inline",selector:p}:c?u={type:"external",url:c}:u={type:"html",path:d||`/portal/content/${i}.html`},await P(f,i,u),a){s=!0;try{a.open(i)}finally{s=!1}}g&&window.scrollTo({top:h-window.innerHeight/2,behavior:"smooth"})}catch(f){console.error("Portal failed to open:",f)}}),window.addEventListener("portal:closed",()=>{if(R(),a){s=!0;try{a.close()}finally{s=!1}}}),a?.init(async({portal:n})=>{if(s)return;if(!n){e.closePortal(0,0);return}const i=document.querySelector(`[data-portal="${n}"]`);if(!i){console.warn(`No portal link found for '${n}'`);return}const l=i?.getAttribute("data-portal-path"),h=i?.getAttribute("data-portal-url"),d=i?.getAttribute("data-portal-inline"),c=i?.getBoundingClientRect(),p=c.left+c.width/2,m=c.top+c.height/2+window.scrollY,g=new CustomEvent("portal:trigger",{detail:{portalName:n,clickX:p,clickY:m,path:l||(d?void 0:`/portal/content/${n}.html`),externalUrl:h,inlineSelector:d,scrollIntoView:!0}});window.dispatchEvent(g)}),{portal:e,router:a}}function L(r){return`Hello, ${r}!`}exports.DomPortal=y;exports.PortalRouter=v;exports.enhancePortalLinks=C;exports.hello=L;exports.loadPortalContent=P;exports.setupDomPortal=T;exports.unloadPortalContent=R;
//# sourceMappingURL=index.cjs.map
